name: Vercel CI/CD
description: Build & Deploy to Vercel
author: Pablo Cru Delhom (pabcrudel)

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

inputs:
  environment:
    description: Which environment should be used
    required: false
    default: preview

runs:
  using: composite
  steps:
    - name: Install Node
      uses: actions/setup-node@v4
      with:
        node-version: 20

    - name: Install pnpm
      uses: pnpm/action-setup@v3
      with:
        version: 8

    - name: Install dependencies
      shell: bash
      run: pnpm install --frozen-lockfile

    - name: Pull Vercel Environment Information
      shell: bash
      run: |
        vercel pull --yes\
        --environment=${{ inputs.environment }}\
        --token=${{secrets.VERCEL_TOKEN }}

    - name: Initialize Prisma client
      shell: bash
      run: pnpm prisma generate

    - name: Build & Deploy Project Artifacts to Vercel
      shell: bash
      run: |
        # "production" must be specified
        if [[ ${{ inputs.environment }} == 'production' ]]; then
          vercel build --prod --token=${{ secrets.VERCEL_TOKEN }};
          vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }};
        else
          vercel build --token=${{ secrets.VERCEL_TOKEN }};
          vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }};
        fi
